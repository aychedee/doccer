<html>
<head>
    <title>Doccer</title>
    <script>

function Doccer() {
    'use strict';

        this.api = function(endpoint, method, callback, data) {
            var xhr;

            if (window.XMLHttpRequest) {
                // code for IE7+, Firefox, Chrome, Opera, Safari
                xhr = new XMLHttpRequest();
            } else {
                // code for IE6, IE5
                xhr = new ActiveXObject("Microsoft.XMLHTTP");
            }

            xhr.onreadystatechange = function() {
                if (xhr.readyState == 4 ) {
                   if(xhr.status == 200){
                       var resp = JSON.parse(xhr.responseText);
                       console.log(resp);
                       callback(resp)
                   }
                   else if(xhr.status == 400) {
                      alert('There was an error 400')
                   }
                   else {
                       alert('something else other than 200 was returned')
                   }
                }
            }
            xhr.open(method, endpoint, true);
            if (method.toLowerCase() === 'post') {
                xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
                xhr.send(data);
            } else {
                xhr.send();
            }
        }

        this.newDoc = function(name, callback) {
            this.api(
                '/new', 'POST', callback,
                'name=' + encodeURIComponent(name)
            )
        }

        this.save = function(name, content, callback) {
            this.api(
                '/save', 'POST', callback,
                'name=' + encodeURIComponent(name) + '&' + 'content=' + encodeURIComponent(content)
            )
        }

        this.listDocs = function(callback) {
            this.api('/docs', 'GET', callback)
        }

        this.getDoc = function(name, callback) {
            this.api('/doc/' + encodeURIComponent(name), 'GET', callback)
        }

        this.getBlob = function(hash, callback) {
            this.api('/blob/' + hash, callback)
        }

        function Doc(doc, doccer) {
            this.name = doc.name;
            this.doccer = doccer
            this.encoded = doc.encoded;
            this.history = [];
            this.position = doc.history.length;
            for (var i=0; i < doc.history.length; i++) {
                this.history.push({
                    date: new Date(doc.history[i].ts),
                    hash: doc.history[i].hash,
                    content: ''
                });
            }
            this.history[position].content = doc.content;

            this.content = function() {
                return this.history[position].content;
            }

            this.back = function(callback) {
                if (this.position <= 0) {
                    return false
                } else {
                    this.position--;
                    this.doccer.api.getBlob(
                        this.history[this.position].hash,
                        function(resp) {console.log(resp);}
                    );

                }

            };


        }

        this.Doc = Doc;

}


var doccer = new Doccer();
doccer.listDocs(function(resp) {
    var docs = document.getElementById('documents');
       for (var i=0; i < resp.length; i++) {
           var link = document.createElement('a');
           link.setAttribute('href', '/d/' + resp[i].encoded);
           var el = document.createElement('button');
           link.appendChild(el);
           el.innerText = resp[i].name;
           el.id = resp[i].hash;
           docs.appendChild(link);

           console.log(resp[i]);
       }
});
    </script>
</head>
<body>
<div id="documents"></div>

<div contenteditable id="content" style="font-family: monospace; font-size: 28px;">
</div>

<form id="saveForm" action="/save" method="POST">
    <input id="contentInput" type=hidden name="content" value=""></input>
</form>
    <button value="Save document" onclick="saveFunc()">Save Current Point</button>
<form action="/save" method="POST">
    <input name="name" placeholder="Enter a new document name" type="text"></input>
    <input type="submit"></input>
</form>
</body>
</html>
