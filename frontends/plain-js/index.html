<html>
<head>
    <title>Doccer</title>
    <script>

function Doccer() {
    'use strict';

        this.api = function(endpoint, method, callback, data) {
            var xhr;

            if (window.XMLHttpRequest) {
                // code for IE7+, Firefox, Chrome, Opera, Safari
                xhr = new XMLHttpRequest();
            } else {
                // code for IE6, IE5
                xhr = new ActiveXObject("Microsoft.XMLHTTP");
            }

            xhr.onreadystatechange = function() {
                if (xhr.readyState == 4 ) {
                   if(xhr.status == 200){
                       var resp = JSON.parse(xhr.responseText);
                       console.log(resp);
                       callback(resp)
                   }
                   else if(xhr.status == 400) {
                      alert('There was an error 400')
                   }
                   else {
                       alert('something else other than 200 was returned')
                   }
                }
            }
            xhr.open(method, endpoint, true);
            if (method.toLowerCase() === 'post') {
                xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
                xhr.send(data);
            } else {
                xhr.send();
            }
        }

        this.newDoc = function(name, callback) {
            this.api(
                '/new', 'POST', callback,
                'name=' + encodeURIComponent(name)
            )
        }

        this.save = function(name, content, callback) {
            this.api(
                '/save', 'POST', callback,
                'name=' + encodeURIComponent(name) + '&' + 'content=' + encodeURIComponent(content)
            )
        }

        this.listDocs = function(callback) {
            this.api('/docs', 'GET', callback)
        }
}

function loadXMLDoc() {
    var xmlhttp;

    if (window.XMLHttpRequest) {
        // code for IE7+, Firefox, Chrome, Opera, Safari
        xmlhttp = new XMLHttpRequest();
    } else {
        // code for IE6, IE5
        xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");
    }

    xmlhttp.onreadystatechange = function() {
        if (xmlhttp.readyState == 4 ) {
           if(xmlhttp.status == 200){
               var docs = document.getElementById("documents");
               var resp = JSON.parse(xmlhttp.responseText);
               console.log(resp);
               for (var i=0; i < resp.length; i++) {
                   var link = document.createElement('a');
                   link.setAttribute('href', '/doc/' + resp[i].encoded);
                   var el = document.createElement('button');
                   link.appendChild(el);
                   el.innerText = resp[i].name;
                   el.id = resp[i].hash;
                   docs.appendChild(link);

                   console.log(resp[i]);
               }
           }
           else if(xmlhttp.status == 400) {
              alert('There was an error 400')
           }
           else {
               alert('something else other than 200 was returned')
           }
        }
    }

    window.saveFunc = function() {
        var i = document.getElementById('contentInput');
        var el = document.getElementById('content');
        i.value = el.innerText;
        document.getElementById('saveForm').submit();

    };

    xmlhttp.open("GET", "/docs/", true);
    xmlhttp.send();
}

loadXMLDoc();

    </script>
</head>
<body>
<div id="documents"></div>

<div contenteditable id="content" style="font-family: monospace; font-size: 28px;">
</div>

<form id="saveForm" action="/save" method="POST">
    <input id="contentInput" type=hidden name="content" value=""></input>
</form>
    <button value="Save document" onclick="saveFunc()">Save Current Point</button>
<form action="/new" method="POST">
    <input name="name" placeholder="Enter a new document name" type="text"></input>
    <input type="submit"></input>
</form>
</body>
</html>
